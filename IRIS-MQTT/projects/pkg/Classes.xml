<?xml version="1.0" encoding="UTF-8"?>
<Export generator="IRIS" version="26" zv="IRIS for UNIX (Ubuntu Server LTS for x86-64 Containers) 2019.2 (Build 107U)" ts="2019-08-14 10:50:12">
<Class name="DriveDemo.Data.CarLatest">
<Super>%Persistent</Super>
<TimeChanged>65206,63715.091922</TimeChanged>
<TimeCreated>65206,59886.347208</TimeCreated>

<Property name="CarId">
<Type>%String</Type>
</Property>

<Property name="Tm">
<Type>%TimeStamp</Type>
</Property>

<Property name="RelativeTm">
<Type>%Integer</Type>
</Property>

<Property name="Longitude">
<Type>%Float</Type>
</Property>

<Property name="Latitude">
<Type>%Float</Type>
</Property>

<Property name="Azimuth">
<Type>%Float</Type>
</Property>

<Property name="Speed">
<Type>%Float</Type>
</Property>

<Property name="EngineRPM">
<Type>%Float</Type>
</Property>

<Property name="AccelPos">
<Type>%Float</Type>
</Property>

<Property name="BrakeSW">
<Type>%Boolean</Type>
</Property>

<Property name="AcumDistance">
<Type>%Float</Type>
</Property>

<Property name="AcumFuel">
<Type>%Float</Type>
</Property>

<Property name="FuelInjection">
<Type>%Float</Type>
</Property>

<Property name="aX">
<Type>%Float</Type>
</Property>

<Property name="aY">
<Type>%Float</Type>
</Property>

<Property name="aZ">
<Type>%Float</Type>
</Property>

<Index name="MainIdx">
<Properties>CarId</Properties>
</Index>

<Index name="TmIdx">
<Properties>Tm</Properties>
</Index>

<Storage name="Default">
<Type>%Storage.Persistent</Type>
<DataLocation>^DriveDemo.Data.CarLatestD</DataLocation>
<DefaultData>CarLatestDefaultData</DefaultData>
<IdLocation>^DriveDemo.Data.CarLatestD</IdLocation>
<IndexLocation>^DriveDemo.Data.CarLatestI</IndexLocation>
<StreamLocation>^DriveDemo.Data.CarLatestS</StreamLocation>
<Data name="CarLatestDefaultData">
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>CarId</Value>
</Value>
<Value name="3">
<Value>Tm</Value>
</Value>
<Value name="4">
<Value>Longitude</Value>
</Value>
<Value name="5">
<Value>Latitude</Value>
</Value>
<Value name="6">
<Value>Azimuth</Value>
</Value>
<Value name="7">
<Value>Speed</Value>
</Value>
<Value name="8">
<Value>EngineRPM</Value>
</Value>
<Value name="9">
<Value>AccelPos</Value>
</Value>
<Value name="10">
<Value>BrakeSW</Value>
</Value>
<Value name="11">
<Value>AcumDistance</Value>
</Value>
<Value name="12">
<Value>AcumFuel</Value>
</Value>
<Value name="13">
<Value>FuelInjection</Value>
</Value>
<Value name="14">
<Value>aX</Value>
</Value>
<Value name="15">
<Value>aY</Value>
</Value>
<Value name="16">
<Value>aZ</Value>
</Value>
<Value name="17">
<Value>RelativeTm</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="DriveDemo.Data.DriveRecord">
<Super>%Persistent,%XML.Adaptor</Super>
<TimeChanged>65205,66773.310576</TimeChanged>
<TimeCreated>65205,66750.001256</TimeCreated>

<Property name="CarId">
<Type>%String</Type>
</Property>

<Property name="RelativeTm">
<Type>%Integer</Type>
</Property>

<Property name="Longitude">
<Type>%Float</Type>
</Property>

<Property name="Latitude">
<Type>%Float</Type>
</Property>

<Property name="Azimuth">
<Type>%Float</Type>
</Property>

<Property name="Speed">
<Type>%Float</Type>
</Property>

<Property name="EngineRPM">
<Type>%Float</Type>
</Property>

<Property name="AccelPos">
<Type>%Float</Type>
</Property>

<Property name="BrakeSW">
<Type>%Boolean</Type>
</Property>

<Property name="AcumDistance">
<Type>%Float</Type>
</Property>

<Property name="AcumFuel">
<Type>%Float</Type>
</Property>

<Property name="FuelInjection">
<Type>%Float</Type>
</Property>

<Property name="aX">
<Type>%Float</Type>
</Property>

<Property name="aY">
<Type>%Float</Type>
</Property>

<Property name="aZ">
<Type>%Float</Type>
</Property>

<Index name="MainIdx">
<Properties>CarId</Properties>
</Index>

<Storage name="Default">
<Type>%Storage.Persistent</Type>
<DataLocation>^DriveDemo.Data.DriveRecordD</DataLocation>
<DefaultData>DriveRecordDefaultData</DefaultData>
<IdLocation>^DriveDemo.Data.DriveRecordD</IdLocation>
<IndexLocation>^DriveDemo.Data.DriveRecordI</IndexLocation>
<StreamLocation>^DriveDemo.Data.DriveRecordS</StreamLocation>
<Data name="DriveRecordDefaultData">
<Structure>listnode</Structure>
<Subscript/>
<Value name="1">
<Value>%%CLASSNAME</Value>
</Value>
<Value name="2">
<Value>CarId</Value>
</Value>
<Value name="3">
<Value>RelativeTm</Value>
</Value>
<Value name="4">
<Value>Longitude</Value>
</Value>
<Value name="5">
<Value>Latitude</Value>
</Value>
<Value name="6">
<Value>Azimuth</Value>
</Value>
<Value name="7">
<Value>Speed</Value>
</Value>
<Value name="8">
<Value>EngineRPM</Value>
</Value>
<Value name="9">
<Value>AccelPos</Value>
</Value>
<Value name="10">
<Value>BrakeSW</Value>
</Value>
<Value name="11">
<Value>AcumDistance</Value>
</Value>
<Value name="12">
<Value>AcumFuel</Value>
</Value>
<Value name="13">
<Value>FuelInjection</Value>
</Value>
<Value name="14">
<Value>aX</Value>
</Value>
<Value name="15">
<Value>aY</Value>
</Value>
<Value name="16">
<Value>aZ</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="DriveDemo.Data.DrivingBehavior">
<Super>%RegisteredObject</Super>
<TimeChanged>65230,41303.341243</TimeChanged>
<TimeCreated>65211,2888.716063</TimeCreated>

<Property name="IsOverSpeed">
<Type>%Boolean</Type>
</Property>

<Property name="IsHighEngineRPM">
<Type>%Boolean</Type>
</Property>

<Property name="IsHighXG">
<Type>%Boolean</Type>
</Property>

<Property name="IsHighYG">
<Type>%Boolean</Type>
</Property>
</Class>


<Class name="DriveDemo.DemoProcessRoutingRule">
<Description>
</Description>
<Super>Ens.Rule.Definition</Super>
<TimeChanged>65230,41348.440009</TimeChanged>
<TimeCreated>65126,38470.15954</TimeCreated>

<Parameter name="RuleAssistClass">
<Default>EnsLib.MsgRouter.VDocRuleAssist</Default>
</Parameter>

<XData name="RuleDefinition">
<XMLNamespace>http://www.intersystems.com/rule</XMLNamespace>
<Data><![CDATA[
<ruleDefinition alias="" context="EnsLib.MsgRouter.VDocRoutingEngine" production="DriveDemo.Production">
<ruleSet name="" effectiveBegin="" effectiveEnd="">
<rule name="" disabled="false">
<constraint name="source" value="MQTTIn"></constraint>
<constraint name="msgClass" value="EnsLib.EDI.XML.Document"></constraint>
<constraint name="docCategory" value="mqtt_schema_driverecord"></constraint>
<constraint name="docName" value="message"></constraint>
<when condition="Piece(Document.{type},&quot;/&quot;,3,3)=&quot;start&quot;">
<send transform="DriveDemo.VDocToCarRegisterRequest" target="CarOperation"></send>
</when>
<when condition="Piece(Document.{type},&quot;/&quot;,3,3)=&quot;drive&quot;">
<send transform="DriveDemo.VDocToCarUpdateRequest" target="CarOperation"></send>
<send transform="DriveDemo.VDocToCheckDriveRequest" target="CheckDriveProcess"></send>
</when>
</rule>
</ruleSet>
</ruleDefinition>
]]></Data>
</XData>
</Class>


<Class name="DriveDemo.Operation.CarUpdateOperation">
<ClassType/>
<ProcedureBlock>1</ProcedureBlock>
<Super>Ens.BusinessOperation</Super>
<TimeChanged>65239,38739.115586</TimeChanged>
<TimeCreated>65206,64643.489865</TimeCreated>

<Parameter name="INVOCATION">
<Description>
2 modes: Queue, InProc</Description>
<Default>Queue</Default>
</Parameter>

<XData name="MessageMap">
<Data><![CDATA[
<MapItems>
    <MapItem MessageType="DriveDemo.Request.CarRegisterRequest">
        <Method>RegisterCar</Method>
    </MapItem>
    <MapItem MessageType="DriveDemo.Request.CarUpdateRequest">
        <Method>UpdateCar</Method>
    </MapItem>
</MapItems>
]]></Data>
</XData>

<UDLText name="T">
<Content><![CDATA[
// 車のstartトッピックがきたら、そのCar IDに対しレコードを作成する

]]></Content>
</UDLText>

<Method name="RegisterCar">
<FormalSpec>pRequest:DriveDemo.Request.CarRegisterRequest,*pResponse:Ens.Response</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    Set carid = pRequest.CarId
    Set ts = pRequest.StartTime
    $$$TRACE("Car ID: "_carid_",  Time: "_ts)

    // デモ目的のため、以前の同一Car IDのレコードを削除する
    &sql(DELETE FROM DriveDemo_Data.DriveRecord where CarId = :carid)
    &sql(DELETE FROM DriveDemo_Data.CarLatest where CarId = :carid)
    &sql(INSERT INTO DriveDemo_Data.CarLatest (CarId, Tm) values (:carid, :ts))
    
    Quit $$$OK
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// driveトピックのメッセージがきたら、最新情報テーブルを更新する

]]></Content>
</UDLText>

<Method name="UpdateCar">
<FormalSpec>pRequest:DriveDemo.Request.CarUpdateRequest,*pResponse:Ens.Response</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 
    // 現在の運転情報を、CarLatestに記録
    Set tCarId = pRequest.Data.CarId
    Set tRelativeTm = pRequest.Data.RelativeTm
    Set tLongitude = pRequest.Data.Longitude
    Set tLatitude = pRequest.Data.Latitude
    Set tAzimuth = pRequest.Data.Azimuth
    Set tSpeed = pRequest.Data.Speed
    Set tEngineRPM = pRequest.Data.EngineRPM
    Set tAccelPos = pRequest.Data.AccelPos
    Set tBrakeSW = pRequest.Data.BrakeSW
    Set tAcumDistance = pRequest.Data.AcumDistance
    Set tAcumFuel = pRequest.Data.AcumFuel
    Set tFuelInjection = pRequest.Data.FuelInjection
    Set taX = pRequest.Data.aX
    Set taY = pRequest.Data.aY
    Set taZ = pRequest.Data.aZ

    &sql(UPDATE DriveDemo_Data.CarLatest SET RelativeTm = :tRelativeTm, Longitude = :tLongitude, Latitude = :tLatitude, Azimuth = :tAzimuth, Speed = :tSpeed, EngineRPM = :tEngineRPM, AccelPos = :tAccelPos, BrakeSW = :tBrakeSW, AcumDistance = :tAcumDistance, AcumFuel = :tAcumFuel, FuelInjection = :tFuelInjection, aX = :taX, aY = :taY, aZ = :taZ where CarId = :tCarId)
 
    $$$TRACE("Car ID: "_tCarId_",  Speed: "_tSpeed)
 
    Quit $$$OK
]]></Implementation>
</Method>
</Class>


<Class name="DriveDemo.Operation.CheckDriveOperation">
<ClassType/>
<ProcedureBlock>1</ProcedureBlock>
<Super>Ens.BusinessOperation</Super>
<TimeChanged>65239,38307.031531</TimeChanged>
<TimeCreated>65211,84649.666717</TimeCreated>

<Parameter name="INVOCATION">
<Description>
2 modes: Queue, InProc</Description>
<Default>Queue</Default>
</Parameter>

<XData name="MessageMap">
<Data><![CDATA[
<MapItem MessageType="DriveDemo.Request.CheckDriveRequest">
        <Method>CheckDrive</Method>
    </MapItem>
]]></Data>
</XData>

<Method name="CheckDrive">
<FormalSpec>pRequest:DriveDemo.Request.CheckDriveRequest,*pResponse:DriveDemo.Response.CheckDriveResponse</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
    Set pResponse=##class(DriveDemo.Response.CheckDriveResponse).%New()
    Set pResponse.hasEvent = 0
    Set pResponse.DrivingBehavior = ##class(DriveDemo.Data.DrivingBehavior).%New()

    Set tCarId = pRequest.CarId
    Set tRelTm = pRequest.RelativeTm
    &sql(SELECT AVG(speed) into :tAvgSpeed FROM DriveDemo_Data.DriveRecord WHERE CarId = :tCarId and RelativeTm BETWEEN :tRelTm - 5 AND :tRelTm)
    $$$TRACE("Car ID: "_tCarId_", Average Speed: "_tAvgSpeed)

    &sql(SELECT EngineRPM, aX, aY into :tEngineRPM, :taX, :taY FROM DriveDemo_Data.DriveRecord WHERE CarId = :tCarId and RelativeTm = :tRelTm)
    $$$TRACE("Car ID: "_tCarId_", RPM: "_$g(tEngineRPM)) 
    
    Set tMsgTxt = ""
    Set tDlm = ""
    if SQLCODE = 0 {
        if +$g(tAvgSpeed) > 100 {
            Set pResponse.hasEvent = 1
            Set pResponse.DrivingBehavior.IsOverSpeed = 1
            Set tMsgTxt = tMsgTxt_tDlm_"Average Speed: "_$fnumber(tAvgSpeed, "", 2)_" km/h"
            Set tDlm = " , "
        }
        if +$g(tEngineRPM) > 3000 {
            Set pResponse.hasEvent = 1
            Set pResponse.DrivingBehavior.IsHighEngineRPM = 1
            Set tMsgTxt = tMsgTxt_tDlm_"Engine RPM: "_tEngineRPM_" rpm"
            Set tDlm = " , "
        }
        if $zabs(+$g(taX)) > 300 {
            Set pResponse.hasEvent = 1
            Set pResponse.DrivingBehavior.IsHighXG = 1
            Set tMsgTxt = tMsgTxt_tDlm_"X acceleration: "_$fnumber((taX / 1000.0), "+", 3)_" G"
            Set tDlm = " , "
        }
        if $zabs(+$g(taY)) > 200 {
            Set pResponse.hasEvent = 1
            Set pResponse.DrivingBehavior.IsHighYG = 1
            Set tMsgTxt = tMsgTxt_tDlm_"Y acceleration: "_$fnumber((taY / 1000.0), "+", 3)_" G"
            Set tDlm = " , "
        }

        if pResponse.hasEvent = 1 {
            Set tMsgTxt = tMsgTxt_tDlm_"Car ID: "_pRequest.CarId
        }
    }

    Set pResponse.MessageText = tMsgTxt
 

    Quit $$$OK
]]></Implementation>
</Method>
</Class>


<Class name="DriveDemo.Process.CheckDriveProcess">
<Description>
</Description>
<Super>Ens.BusinessProcessBPL</Super>
<TimeChanged>65230,41273.961225</TimeChanged>
<TimeCreated>65211,85233.391281</TimeCreated>

<Storage name="Default">
<Type>%Storage.Persistent</Type>
</Storage>

<XData name="BPL">
<Description>
BPL Definition</Description>
<XMLNamespace>http://www.intersystems.com/bpl</XMLNamespace>
<Data><![CDATA[
<process language='objectscript' request='DriveDemo.Request.CheckDriveRequest' response='DriveDemo.Response.CheckDriveResponse' height='2000' width='2000' >
<context>
<property name='drivingstatus' type='%String' instantiate='0' >
<parameters>
<parameter name='MAXLEN'  value='2500' />
</parameters>
</property>
</context>
<sequence xend='200' yend='700' >
<call name='CheckDrivingBehavior' target='CheckDriveOperation' async='0' xpos='200' ypos='250' >
<request type='DriveDemo.Request.CheckDriveRequest' >
<assign property="callrequest" value="request" action="set" />
</request>
<response type='DriveDemo.Response.CheckDriveResponse' >
<assign property="context.drivingstatus" value="callresponse.MessageText" action="set" />
<assign property="response" value="callresponse" action="set" />
</response>
</call>
<if name='EventHappened?' condition='response.hasEvent = 1' xpos='200' ypos='350' xend='200' yend='600' >
<true>
<call name='NotifyEvent' target='MQTTOut' async='1' xpos='335' ypos='500' >
<request type='Ens.StringContainer' >
<assign property="callrequest.StringValue" value="response.MessageText" action="set" />
</request>
<response type='Ens.Response' />
</call>
</true>
</if>
</sequence>
</process>
]]></Data>
</XData>
</Class>


<Class name="DriveDemo.Production">
<Super>Ens.Production</Super>
<TimeChanged>65230,41182.740694</TimeChanged>
<TimeCreated>65205,39772.533129</TimeCreated>

<XData name="ProductionDefinition">
<Data><![CDATA[
<Production Name="DriveDemo.Production" LogGeneralTraceEvents="false">
  <Description></Description>
  <ActorPoolSize>5</ActorPoolSize>
  <Item Name="EnsLib.JavaGateway.Initiator" Category="" ClassName="EnsLib.JavaGateway.Initiator" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="false" Schedule="">
    <Setting Target="Host" Name="ClassPath">/projects/srcs/java/lib/org.eclipse.paho.client.mqttv3-1.2.0.jar</Setting>
  </Item>
  <Item Name="RoutingProcess" Category="" ClassName="EnsLib.MsgRouter.VDocRoutingEngine" PoolSize="5" Enabled="true" Foreground="false" Comment="" LogTraceEvents="false" Schedule="">
    <Setting Target="Host" Name="BusinessRuleName">DriveDemo.DemoProcessRoutingRule</Setting>
  </Item>
  <Item Name="CarOperation" Category="" ClassName="DriveDemo.Operation.CarUpdateOperation" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="false" Schedule="">
  </Item>
  <Item Name="CheckDriveOperation" Category="" ClassName="DriveDemo.Operation.CheckDriveOperation" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="true" Schedule="">
  </Item>
  <Item Name="CheckDriveProcess" Category="" ClassName="DriveDemo.Process.CheckDriveProcess" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="false" Schedule="">
  </Item>
  <Item Name="MQTTIn" Category="" ClassName="JBH.Com.Intersystems.Drivedemo.MqttBS" PoolSize="0" Enabled="true" Foreground="false" Comment="" LogTraceEvents="false" Schedule="">
    <Setting Target="Host" Name="DocSchemaCategory">mqtt_schema_driverecord</Setting>
    <Setting Target="Host" Name="MQTTBroker">tcp://mqttbroker:1883</Setting>
    <Setting Target="Host" Name="MQTTClientName">IRISClient</Setting>
    <Setting Target="Host" Name="MQTTTopicRoot">DriveDemo/#</Setting>
    <Setting Target="Host" Name="TargetConfigNames">RoutingProcess</Setting>
    <Setting Target="Host" Name="LogFile">/projects/logs/MQTTBS.log</Setting>
  </Item>
  <Item Name="MQTTOut" Category="" ClassName="JBH.Com.Intersystems.Drivedemo.MqttBO" PoolSize="1" Enabled="true" Foreground="false" Comment="" LogTraceEvents="false" Schedule="">
    <Setting Target="Host" Name="LogFile">/projects/logs/MQTTBO.log</Setting>
    <Setting Target="Host" Name="MQTTBroker">tcp://mqttbroker:1883</Setting>
    <Setting Target="Host" Name="MQTTClientName">IRISClientOut</Setting>
    <Setting Target="Host" Name="MQTTTopicRoot">DriveDemo/Event</Setting>
  </Item>
</Production>
]]></Data>
</XData>
</Class>


<Class name="DriveDemo.Request.CarRegisterRequest">
<ClassType>persistent</ClassType>
<ProcedureBlock>1</ProcedureBlock>
<Super>Ens.Request</Super>
<TimeChanged>65210,51122.368184</TimeChanged>
<TimeCreated>65206,59084.97983</TimeCreated>

<Property name="CarId">
<Type>%String</Type>
</Property>

<Property name="StartTime">
<Type>%TimeStamp</Type>
</Property>

<Property name="Type">
<Type>%String</Type>
</Property>

<Storage name="Default">
<Type>%Storage.Persistent</Type>
<DefaultData>CarRegisterRequestDefaultData</DefaultData>
<Data name="CarRegisterRequestDefaultData">
<Subscript>"CarRegisterRequest"</Subscript>
<Value name="1">
<Value>CarId</Value>
</Value>
<Value name="2">
<Value>StartTime</Value>
</Value>
<Value name="3">
<Value>Type</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="DriveDemo.Request.CarUpdateRequest">
<ClassType>persistent</ClassType>
<ProcedureBlock>1</ProcedureBlock>
<Super>Ens.Request</Super>
<TimeChanged>65211,84241.390749</TimeChanged>
<TimeCreated>65205,43428.04414</TimeCreated>

<Property name="Data">
<Type>DriveDemo.Data.DriveRecord</Type>
</Property>

<UDLText name="T">
<Content><![CDATA[
// Property jsonData As %XML.String(MAXLEN = 32767);

]]></Content>
</UDLText>

<Storage name="Default">
<Type>%Storage.Persistent</Type>
<DefaultData>CarUpdateRequestDefaultData</DefaultData>
<Data name="CarUpdateRequestDefaultData">
<Subscript>"CarUpdateRequest"</Subscript>
<Value name="1">
<Value>CarId</Value>
</Value>
<Value name="2">
<Value>jsonData</Value>
</Value>
<Value name="3">
<Value>Data</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="DriveDemo.Request.CheckDriveRequest">
<ClassType>persistent</ClassType>
<ProcedureBlock>1</ProcedureBlock>
<Super>Ens.Request</Super>
<TimeChanged>65211,84073.396088</TimeChanged>
<TimeCreated>65211,83928.144902</TimeCreated>

<Property name="CarId">
<Type>%String</Type>
</Property>

<Property name="RelativeTm">
<Type>%Integer</Type>
</Property>

<Storage name="Default">
<Type>%Storage.Persistent</Type>
<DefaultData>CheckDriveRequestDefaultData</DefaultData>
<Data name="CheckDriveRequestDefaultData">
<Subscript>"CheckDriveRequest"</Subscript>
<Value name="1">
<Value>CarId</Value>
</Value>
<Value name="2">
<Value>RelativeTm</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="DriveDemo.Response.CheckDriveResponse">
<ClassType>persistent</ClassType>
<ProcedureBlock>1</ProcedureBlock>
<Super>Ens.Response</Super>
<TimeChanged>65230,41262.160342</TimeChanged>
<TimeCreated>65211,84739.910432</TimeCreated>

<Property name="hasEvent">
<Type>%Boolean</Type>
</Property>

<Property name="DrivingBehavior">
<Type>DriveDemo.Data.DrivingBehavior</Type>
</Property>

<Property name="MessageText">
<Type>%String</Type>
<Parameter name="MAXLEN" value="32767"/>
</Property>

<Storage name="Default">
<Type>%Storage.Persistent</Type>
<DefaultData>CarUpdateRequestDefaultData</DefaultData>
<Data name="CarUpdateRequestDefaultData">
<Subscript>"CarUpdateRequest"</Subscript>
<Value name="1">
<Value>hasEvent</Value>
</Value>
<Value name="2">
<Value>DrivingBehavior</Value>
</Value>
<Value name="3">
<Value>MessageText</Value>
</Value>
</Data>
</Storage>
</Class>


<Class name="DriveDemo.VDocToCarRegisterRequest">
<Super>Ens.DataTransformDTL</Super>
<TimeChanged>65210,51195.347065</TimeChanged>
<TimeCreated>65206,60590.189861</TimeCreated>
<DependsOn>EnsLib.EDI.XML.Document,DriveDemo.Request.CarRegisterRequest</DependsOn>

<Parameter name="IGNOREMISSINGSOURCE">
<Default>1</Default>
</Parameter>

<Parameter name="REPORTERRORS">
<Default>1</Default>
</Parameter>

<Parameter name="TREATEMPTYREPEATINGFIELDASNULL">
<Default>0</Default>
</Parameter>

<XData name="DTL">
<XMLNamespace>http://www.intersystems.com/dtl</XMLNamespace>
<Data><![CDATA[
<transform sourceClass='EnsLib.EDI.XML.Document' targetClass='DriveDemo.Request.CarRegisterRequest' sourceDocType='mqtt_schema_driverecord:message' create='new' language='objectscript' >
<assign value='..Piece(source.{type},"/",2)' property='target.CarId' action='set' />
<assign value='source.{DriveRecord.starttime}' property='target.StartTime' action='set' />
<assign value='..Piece(source.{type},"/",3)' property='target.Type' action='set' />
</transform>
]]></Data>
</XData>
</Class>


<Class name="DriveDemo.VDocToCarUpdateRequest">
<Super>Ens.DataTransformDTL</Super>
<TimeChanged>65217,43647.806653</TimeChanged>
<TimeCreated>65217,43647.806653</TimeCreated>
<DependsOn>EnsLib.EDI.XML.Document,DriveDemo.Request.CarUpdateRequest</DependsOn>

<Parameter name="IGNOREMISSINGSOURCE">
<Default>1</Default>
</Parameter>

<Parameter name="REPORTERRORS">
<Default>1</Default>
</Parameter>

<Parameter name="TREATEMPTYREPEATINGFIELDASNULL">
<Default>0</Default>
</Parameter>

<XData name="DTL">
<XMLNamespace>http://www.intersystems.com/dtl</XMLNamespace>
<Data><![CDATA[
<transform sourceClass='EnsLib.EDI.XML.Document' targetClass='DriveDemo.Request.CarUpdateRequest' sourceDocType='mqtt_schema_driverecord:message' create='new' language='objectscript' >
<assign value='source.{DriveRecord}' property='target.Data' action='set' />
<assign value='..Piece(source.{type},"/",2)' property='target.Data.CarId' action='set' />
<assign value='source.{DriveRecord.time}' property='target.Data.RelativeTm' action='set' />
<assign value='source.{DriveRecord.longitude}' property='target.Data.Longitude' action='set' />
<assign value='source.{DriveRecord.azimuth}' property='target.Data.Azimuth' action='set' />
<assign value='source.{DriveRecord.car_speed}' property='target.Data.Speed' action='set' />
<assign value='source.{DriveRecord.engine_rpm}' property='target.Data.EngineRPM' action='set' />
<assign value='source.{DriveRecord.accel_pos}' property='target.Data.AccelPos' action='set' />
<assign value='source.{DriveRecord.brake_sw}' property='target.Data.BrakeSW' action='set' />
<assign value='source.{DriveRecord.accum_dist}' property='target.Data.AcumDistance' action='set' />
<assign value='source.{DriveRecord.accum_fuel}' property='target.Data.AcumFuel' action='set' />
<assign value='source.{DriveRecord.fuel_injection}' property='target.Data.FuelInjection' action='set' />
<assign value='source.{DriveRecord.a_000_x}' property='target.Data.aX' action='set' />
<assign value='source.{DriveRecord.a_000_y}' property='target.Data.aY' action='set' />
<assign value='source.{DriveRecord.a_000_z}' property='target.Data.aZ' action='set' />
<assign value='source.{DriveRecord.latitude}' property='target.Data.Latitude' action='set' />
</transform>
]]></Data>
</XData>
</Class>


<Class name="DriveDemo.VDocToCheckDriveRequest">
<Super>Ens.DataTransformDTL</Super>
<TimeChanged>65211,84417.441494</TimeChanged>
<TimeCreated>65211,84377.26604</TimeCreated>
<DependsOn>EnsLib.EDI.XML.Document,DriveDemo.Request.CheckDriveRequest</DependsOn>

<Parameter name="IGNOREMISSINGSOURCE">
<Default>1</Default>
</Parameter>

<Parameter name="REPORTERRORS">
<Default>1</Default>
</Parameter>

<Parameter name="TREATEMPTYREPEATINGFIELDASNULL">
<Default>0</Default>
</Parameter>

<XData name="DTL">
<XMLNamespace>http://www.intersystems.com/dtl</XMLNamespace>
<Data><![CDATA[
<transform sourceClass='EnsLib.EDI.XML.Document' targetClass='DriveDemo.Request.CheckDriveRequest' sourceDocType='mqtt_schema_driverecord:message' create='new' language='objectscript' >
<assign value='..Piece(source.{type},"/",2)' property='target.CarId' action='set' />
<assign value='source.{DriveRecord.time}' property='target.RelativeTm' action='set' />
</transform>
]]></Data>
</XData>
</Class>


<Class name="DriveDemo.impl">
<Description><![CDATA[
Drive Demo: REST APIの定義<br/>
Business logic class defined by OpenAPI in DriveDemo.spec<br/>
Updated Aug 14, 2019 10:42:07]]></Description>
<ProcedureBlock>1</ProcedureBlock>
<Super>%REST.Impl</Super>
<TimeChanged>65239,38527.220879</TimeChanged>
<TimeCreated>65231,54546.756798</TimeCreated>

<Parameter name="ExposeServerExceptions">
<Description>
If ExposeServerExceptions is true, then details of internal errors will be exposed.</Description>
<Default>0</Default>
</Parameter>

<Method name="getAllCars">
<Description>
すべての車の情報を返す</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec/>
<ReturnType>%DynamicObject</ReturnType>
<Implementation><![CDATA[
    // SQLで車の最新情報を取得し、DynamicObjectを生成する
    Set tArr = []
    Set tRS = ##class(%SQL.Statement).%ExecDirect(,"SELECT CarId, RelativeTm, Longitude, Latitude, Azimuth, Speed, EngineRPM, AccelPos, BrakeSW, aX, aY, aZ FROM DriveDemo_Data.CarLatest order by CarId")
    While tRS.%Next() {
        Do tArr.%Push({
            "carid":    (tRS.%Get("CarId")),
            "relativetm":    (tRS.%Get("RelativeTm")),
            "longitude":    (tRS.%Get("Longitude")),
            "latitude":    (tRS.%Get("Latitude")),
            "azimuth":    (tRS.%Get("Azimuth")),
            "speed":    (tRS.%Get("Speed")),
            "enginerpm":    (tRS.%Get("EngineRPM")),
            "accelpos":    (tRS.%Get("AccelPos")),
            "brakesw":    (tRS.%Get("BrakeSW")),
            "aX":    (tRS.%Get("aX")),
            "aY":    (tRS.%Get("aY")),
            "aZ":    (tRS.%Get("aZ"))
        })
    }
    Do ..%SetStatusCode(200)
    Quit tArr.%ToJSON()
]]></Implementation>
</Method>
</Class>


<Class name="DriveDemo.spec">
<ProcedureBlock>1</ProcedureBlock>
<Super>%REST.Spec</Super>
<TimeChanged>65239,38527.186975</TimeChanged>
<TimeCreated>65231,55309.425131</TimeCreated>

<UDLText name="T">
<Content><![CDATA[
// CORSリクエストに対応する

]]></Content>
</UDLText>

<Parameter name="HandleCorsRequest">
<Default>1</Default>
</Parameter>

<XData name="OpenAPI">
<MimeType>application/json</MimeType>
<Data><![CDATA[
{
  "swagger":"2.0",
  "info":{
    "version":"1.0.0",
    "title":"Drive Demo",
    "description":"Drive Demo: REST APIの定義",
    "termsOfService":"http://swagger.io/terms/",
    "contact":{
      "name":"InterSystems Japan"
    },
    "license":{
      "name":"MIT"
    }
  },
  "basePath":"/csp/DriveDemo",
  "schemes":[
    "http"
  ],
  "consumes":[
    "application/json"
  ],
  "produces":[
    "application/json"
  ],
  "paths":{
    "/cars":{
      "get":{
        "description":"すべての車の情報を返す",
        "operationId":"getAllCars",
        "produces":[
          "application/json"
        ],
        "responses":{
          "200":{
            "description":"車のリスト",
            "schema":{
              "type":"array",
              "items":{
                "$ref":"#/definitions/Car"
              }
            }
          }
        }
      }
    }
  },
  "definitions":{
    "Car":{
      "type":"object",
      "required":[
        "carid",
        "relativetm",
        "longitude",
        "latitude",
        "azimuth",
        "speed",
        "enginerpm",
        "accelpos",
        "brakesw"
      ],
      "properties":{
        "carid":{
          "type":"string"
        },
        "relativetm":{
          "type":"number",
          "format":"int32"
        },
        "longitude":{
          "type":"number",
          "format":"float"
        },
        "latitude":{
          "type":"number",
          "format":"float"
        },
        "azimuth":{
          "type":"number",
          "format":"float"
        },
        "speed":{
          "type":"number",
          "format":"float"
        },
        "enginerpm":{
          "type":"number",
          "format":"float"
        },
        "accelpos":{
          "type":"number",
          "format":"float"
        },
        "brakesw":{
          "type":"number",
          "format":"float"
        },
        "aX":{
          "type":"number",
          "format":"float"
        },
        "aY":{
          "type":"number",
          "format":"float"
        },
        "aZ":{
          "type":"number",
          "format":"float"
        }
      }
    }
  }
}
]]></Data>
</XData>
</Class>
</Export>
